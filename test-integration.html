<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Covenant: Integration Test - Proof → Sign → Broadcast</title>
  <style>
    body {
      font-family: monospace;
      background: #1a1a2e;
      color: #00ff00;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #16c784; }
    .test-section {
      background: #0f0f1e;
      border: 1px solid #16c784;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    .test-item {
      background: #1a1a2e;
      padding: 10px;
      margin: 10px 0;
      border-left: 2px solid #16c784;
      padding-left: 15px;
    }
    .status-ok { color: #16c784; }
    .status-fail { color: #ff6b6b; }
    .status-pending { color: #ffa500; }
    pre {
      background: #000;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
    }
    button {
      background: #16c784;
      color: #000;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
      margin: 5px;
    }
    button:hover { background: #00ff00; }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>⚡ Covenant Integration Test</h1>
  <p>Full flow: Proof Generation → Wallet Signing → Atomic Broadcast</p>

  <div class="test-section">
    <h2>1. CharmsCLIProver</h2>
    <div id="test-prover" class="test-item status-pending">⏳ Not yet run</div>
    <button onclick="testProver()">Test Proof Generation</button>
  </div>

  <div class="test-section">
    <h2>2. UnisatWallet 2-TX Pattern</h2>
    <div id="test-wallet" class="test-item status-pending">⏳ Not yet run</div>
    <button onclick="testWallet()">Test Wallet Integration</button>
  </div>

  <div class="test-section">
    <h2>3. CharmsClient Full Flow</h2>
    <div id="test-charms" class="test-item status-pending">⏳ Not yet run</div>
    <button onclick="testCharmsClient()">Test Full Flow</button>
  </div>

  <div class="test-section">
    <h2>4. OnChainUI Integration</h2>
    <div id="test-ui" class="test-item status-pending">⏳ Not yet run</div>
    <button onclick="testUI()">Test UI</button>
  </div>

  <div class="test-section">
    <h2>Test Results</h2>
    <pre id="results"></pre>
    <button onclick="clearResults()">Clear</button>
    <button onclick="runAllTests()">Run All Tests</button>
  </div>

  <script src="js/bitcoin/CharmsCLIProver.js"></script>
  <script src="js/bitcoin/CharmsClient.js"></script>
  <script src="js/bitcoin/UnisatWallet.js"></script>
  <script src="js/bitcoin/OnChainUI.js"></script>

  <script>
    let results = [];

    function log(msg) {
      console.log(msg);
      results.push(msg);
      updateResults();
    }

    function updateResults() {
      document.getElementById('results').textContent = results.join('\n');
    }

    function setStatus(elemId, status, msg) {
      const elem = document.getElementById(elemId);
      elem.textContent = msg;
      elem.className = `test-item status-${status}`;
      
      const icon = status === 'ok' ? '✓' : status === 'fail' ? '✗' : '⏳';
      log(`${icon} ${elemId}: ${msg}`);
    }

    function clearResults() {
      results = [];
      document.getElementById('results').textContent = '';
      document.querySelectorAll('.test-item').forEach(el => {
        el.className = 'test-item status-pending';
        el.textContent = '⏳ Not yet run';
      });
    }

    function testProver() {
      try {
        log('\n=== Testing CharmsCLIProver ===');
        if (typeof CharmsCLIProver === 'undefined') {
          throw new Error('CharmsCLIProver not loaded');
        }
        log('✓ CharmsCLIProver class exists');
        const requiredMethods = ['generateProof'];
        requiredMethods.forEach(method => {
          if (typeof CharmsCLIProver.prototype[method] !== 'function') {
            throw new Error(`Missing method: ${method}`);
          }
          log(`✓ Method exists: ${method}`);
        });
        log('ℹ Full test requires Node.js with Charms CLI');
        setStatus('test-prover', 'ok', '✓ CharmsCLIProver ready');
      } catch (error) {
        log(`✗ Error: ${error.message}`);
        setStatus('test-prover', 'fail', `✗ ${error.message}`);
      }
    }

    function testWallet() {
      try {
        log('\n=== Testing UnisatWallet ===');
        if (typeof UnisatWalletIntegration === 'undefined') {
          throw new Error('UnisatWalletIntegration not loaded');
        }
        log('✓ UnisatWalletIntegration class exists');
        const requiredMethods = ['signAndBroadcast2TxPattern', '_submitPackage', '_sequentialBroadcast'];
        requiredMethods.forEach(method => {
          if (typeof UnisatWalletIntegration.prototype[method] !== 'function') {
            throw new Error(`Missing method: ${method}`);
          }
          log(`✓ Method exists: ${method}`);
        });
        const wallet = new UnisatWalletIntegration('signet');
        log('✓ Wallet instance created');
        log(`ℹ Unisat available: ${wallet.hasUnisat}`);
        log(`ℹ Leather available: ${wallet.hasLeather}`);
        setStatus('test-wallet', 'ok', '✓ UnisatWallet ready (requires Unisat extension)');
      } catch (error) {
        log(`✗ Error: ${error.message}`);
        setStatus('test-wallet', 'fail', `✗ ${error.message}`);
      }
    }

    function testCharmsClient() {
      try {
        log('\n=== Testing CharmsClient ===');
        if (typeof CharmsGameClient === 'undefined') {
          throw new Error('CharmsGameClient not loaded');
        }
        log('✓ CharmsGameClient class exists');
        const requiredMethods = ['submitMove', 'submitReputationOnChain', '_generateProofViaCharms', '_callServerAPI'];
        requiredMethods.forEach(method => {
          if (typeof CharmsGameClient.prototype[method] !== 'function') {
            throw new Error(`Missing method: ${method}`);
          }
          log(`✓ Method exists: ${method}`);
        });
        const client = new CharmsGameClient('test-app', 'tb1qtest', {
          serverUrl: 'http://localhost:3000'
        });
        log('✓ CharmsClient instance created');
        log(`ℹ Mode: server API (http://localhost:3000)`);
        setStatus('test-charms', 'ok', '✓ CharmsClient ready (serverUrl mode)');
      } catch (error) {
        log(`✗ Error: ${error.message}`);
        setStatus('test-charms', 'fail', `✗ ${error.message}`);
      }
    }

    function testUI() {
      try {
        log('\n=== Testing OnChainUI ===');
        if (typeof OnChainUI === 'undefined') {
          throw new Error('OnChainUI not loaded');
        }
        log('✓ OnChainUI object exists');
        const requiredMethods = ['submitMove', 'addTransaction', 'updateTransactionDisplay', 'showStatus'];
        requiredMethods.forEach(method => {
          if (typeof OnChainUI[method] !== 'function') {
            throw new Error(`Missing method: ${method}`);
          }
          log(`✓ Method exists: ${method}`);
        });
        if (typeof OnChainUI.showStatus !== 'function') {
          throw new Error('Missing showStatus method');
        }
        log('✓ showStatus method exists for progress updates');
        setStatus('test-ui', 'ok', '✓ OnChainUI ready');
      } catch (error) {
        log(`✗ Error: ${error.message}`);
        setStatus('test-ui', 'fail', `✗ ${error.message}`);
      }
    }

    function runAllTests() {
      clearResults();
      log('Running all integration tests...\n');
      testProver();
      testWallet();
      testCharmsClient();
      testUI();
      log('\n=== Summary ===');
      log('All components loaded and ready for end-to-end testing');
      log('Next: Run server.js and test with real wallet');
    }

    window.onload = function() {
      log('Integration test environment ready');
      log('Click "Run All Tests" to validate all components');
    };
  </script>
</body>
</html>
